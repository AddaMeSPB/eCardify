default_platform(:ios)

# ---------- Constants ----------
XCODE_PROJECT = "eCardify.xcodeproj"
IOS_SCHEME    = "eCardify"
BUNDLE_ID     = "cardify.addame.com.eCardify"
TEAM_ID       = "6989658CU5"

# ---------- Helper Methods ----------

def api_key
  if ENV["APP_STORE_CONNECT_API_KEY_ID"]
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )
  elsif File.exist?("../fastlane/api_key.json")
    json = JSON.parse(File.read("../fastlane/api_key.json"))
    app_store_connect_api_key(
      key_id: json["key_id"],
      issuer_id: json["issuer_id"],
      key_content: json["key"],
      in_house: false
    )
  else
    UI.user_error!("No App Store Connect API key configured. Set APP_STORE_CONNECT_API_KEY_ID env var or create fastlane/api_key.json")
  end
end

platform :ios do

  desc "Sync code signing certificates and profiles"
  lane :certs do
    match(type: "appstore", api_key: api_key)
  end

  desc "Force regenerate provisioning profile (e.g. after adding capabilities)"
  lane :regen_profile do
    match(type: "appstore", force_for_new_devices: true, api_key: api_key)
  end

  desc "Generate new localized screenshots"
  lane :screenshots do
    capture_screenshots(project: XCODE_PROJECT, scheme: "eCardifyUITests")
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    key = api_key
    match(type: "appstore", readonly: true, api_key: key)
    build_app(
      project: XCODE_PROJECT,
      scheme: IOS_SCHEME,
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          BUNDLE_ID => "match AppStore #{BUNDLE_ID}"
        },
        signingCertificate: "Apple Distribution",
        teamID: TEAM_ID
      },
      xcargs: "DEVELOPMENT_TEAM=#{TEAM_ID}",
      clean: true
    )
    upload_to_testflight(api_key: key, skip_waiting_for_build_processing: true)
  end

  desc "Upload metadata only to App Store Connect"
  lane :metadata do
    key = api_key
    deliver(
      api_key: key,
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true,
      precheck_include_in_app_purchases: false
    )
  end

end
